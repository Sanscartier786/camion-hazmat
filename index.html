<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mon App Camion HazMat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        #alerte-box {
            display: none; 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 0, 0, 0.9); 
            color: white;
            z-index: 9999;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            text-align: center;
        }
        #alerte-texte {
            font-size: 40px; font-weight: bold; font-family: Arial, sans-serif;
            text-transform: uppercase;
            animation: clignote 0.5s infinite;
        }
        @keyframes clignote { 50% { opacity: 0.2; } }

        #info-box {
            position: absolute; bottom: 20px; left: 20px;
            background: white; padding: 10px; border-radius: 5px;
            font-family: sans-serif; 
            z-index: 10001; 
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="alerte-box" style="display:none;">
    <div id="alerte-texte">⛔ TUNNEL INTERDIT ⛔<br>HAZMAT DÉTECTÉ</div>
</div>

<div id="info-box">Recherche du GPS...</div>
<div id="map"></div>

<script>
    // TA CLÉ MAPBOX
    mapboxgl.accessToken = 'pk.eyJ1IjoiYm9iMTkiLCJhIjoiY21qOWpybDZ0MDFwcDNkcTd4MjVqaHZjdiJ9.Wp3zVaQn2A-IWUwTRvpjtA';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/navigation-night-v1',
        center: [-73.56, 45.50], // Centré sur Montréal pour voir les zones
        zoom: 11
    });

    // ZONES INTERDITES V3 (ULTRA PRÉCISION)
    // Stratégie : On couvre seulement le MILIEU des tunnels pour laisser les sorties libres.
    const zonesInterdites = {
        'type': 'FeatureCollection',
        'features': [
            {
                'type': 'Feature', 
                'properties': { 'nom': 'Tunnel Lafontaine (Fleuve Uniquement)' },
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [[
                        // On commence APRÈS la rive (dans l'eau) pour laisser les sorties libres
                        [-73.5055, 45.5765], // Rive Nord (Dans le fleuve)
                        [-73.5045, 45.5770], 
                        [-73.5000, 45.5710], // Rive Sud (Dans le fleuve)
                        [-73.5010, 45.5705],
                        [-73.5055, 45.5765]  // On ferme la boucle
                    ]]
                }
            },
            {
                'type': 'Feature',
                'properties': { 'nom': 'Tunnel Ville-Marie (Centre)' },
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [[
                        // Forme complexe qui suit la courbe de l'autoroute 720
                        // On laisse les entrées Guy et les sorties Atwater libres
                        [-73.5750, 45.4950], // Début zone (Vers Guy/Concordia)
                        [-73.5650, 45.5030], // Virage du centre-ville
                        [-73.5520, 45.5140], // Fin zone (Vers Viger/Papineau)
                        
                        [-73.5510, 45.5130], // On redescend (largeur de l'autoroute)
                        [-73.5640, 45.5020], 
                        [-73.5740, 45.4940],
                        [-73.5750, 45.4950]  // On ferme
                    ]]
                }
            }
        ]
    };

    map.on('load', () => {
        map.addSource('source-zones', { 'type': 'geojson', 'data': zonesInterdites });
        map.addLayer({
            'id': 'layer-zones',
            'type': 'fill',
            'source': 'source-zones',
            'paint': { 'fill-color': '#ff0000', 'fill-opacity': 0.4 }
        });

        const geolocate = new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true
        });
        map.addControl(geolocate);

        geolocate.on('geolocate', (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const maPosition = turf.point([lon, lat]);

            document.getElementById('info-box').innerText = 
                `Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}`;

            let danger = false;
            zonesInterdites.features.forEach(function(zone) {
                if (turf.booleanPointInPolygon(maPosition, zone)) {
                    danger = true;
                }
            });

            const ecranAlerte = document.getElementById('alerte-box');
            if (danger) {
                ecranAlerte.style.display = 'flex';
            } else {
                ecranAlerte.style.display = 'none';
            }
        });
    });
</script>

</body>
</html>
